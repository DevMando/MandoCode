@using MandoCode.Services
@using Spectre.Console
@inject AIService AI


<Panel Title="MandoCode - Local AI Coding Assistant" Border="@BoxBorder.Rounded">
    <Rows>
        <Markup Content="Powered by Semantic Kernel and Ollama" />
        <Markup Content="Type 'exit' to quit, 'clear' to reset conversation" />
 @*        <Rule /> *@

        @if (!string.IsNullOrEmpty(_currentResponse))
        {
            <Panel Title="Assistant" Border="@BoxBorder.Rounded">
                <Markup Content="@_currentResponse" />
            </Panel>
        }

        @if (_isProcessing)
        {
            <Markup Content="⏳ Processing..." />
        }
    </Rows>
</Panel>

@code {
    private string _currentResponse = string.Empty;
    private bool _isProcessing = false;

    protected override void OnInitialized()
    {
        _currentResponse = "MandoCode is ready!\n\n" +
                          "I can help you with:\n" +
                          "• Reading and analyzing code\n" +
                          "• Refactoring and improving code\n" +
                          "• Writing new features\n" +
                          "• Understanding project structure\n" +
                          "• Git operations\n\n" +
                          "What would you like me to help with?";
    }

    public async Task ProcessUserInput(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return;

        _isProcessing = true;
        StateHasChanged();

        try
        {
            if (input.Trim().ToLower() == "clear")
            {
                AI.ClearHistory();
                _currentResponse = "Conversation context cleared. How can I help you?";
            }
            else
            {
                var response = await AI.ChatAsync(input);
                _currentResponse = response;
            }
        }
        catch (Exception ex)
        {
            _currentResponse = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }
}
